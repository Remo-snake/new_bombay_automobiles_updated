{% extends 'base.html' %}
{% block title %}Salary Payment{% endblock %}

{% block content %}
<div class="container-fluid p-3">

<h4 class="mb-3">Salary Payment</h4>

<div class="card p-3 mb-4">
<form method="post">{% csrf_token %}

<label>Staff</label>
<select id="staff" name="staff" class="form-control mb-2" required>
  <option value="">-- Select Staff --</option>
  {% for s in staff_list %}
  <option value="{{ s.id }}">{{ s.user.username }}</option>
  {% endfor %}
</select>

<label>Month</label>
<input type="month" id="month" name="month"
       class="form-control mb-2" required>

<div id="salaryPreview" class="alert d-none"></div>

<label>Paid Amount</label>
<input type="number" step="0.01"
       id="paid_amount" name="paid_amount"
       class="form-control mb-2" required>

<label>Payment Mode</label>
<select name="mode" class="form-control mb-2">
  <option value="Cash">Cash</option>
  <option value="UPI">UPI</option>
  <option value="Bank">Bank Transfer</option>
</select>

<label>Remark</label>
<input type="text" name="remark"
       class="form-control mb-3">

<button class="btn btn-success w-100">
  Save Salary Payment
</button>

</form>
</div>

<div class="card p-3">
<h5>Salary Payment History</h5>
<table class="table table-bordered">
<thead>
<tr>
<th>Staff</th>
<th>Month</th>
<th>Gross</th>
<th>Advance</th>
<th>Net</th>
<th>Paid</th>
</tr>
</thead>
<tbody>
{% for p in payments %}
<tr>
<td>{{ p.staff.user.username }}</td>
<td>{{ p.month }}/{{ p.year }}</td>
<td>₹ {{ row.gross_salary|floatformat:2|intcomma }}</td>
<td>₹ {{ p.advances }}</td>
<td><strong>₹ {{ row.net|floatformat:2|intcomma }}</strong></td>
<td>₹ {{ p.paid_amount }}</td>
</tr>
{% empty %}
<tr>
<td colspan="6" class="text-center text-muted">
No salary payments recorded
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

</div>

<script>
$(function () {
  function loadSalary() {
    let staff = $('#staff').val();
    let month = $('#month').val();

    if (!staff || !month) return;

    $.get("{% url 'salary_preview' %}", {
      staff: staff,
      month: month
    }, function (res) {

      if (res.error) {
        $('#salaryPreview')
          .removeClass('d-none alert-info')
          .addClass('alert alert-danger')
          .html(res.error);
        $('#paid_amount').val('');
        return;
      }

      $('#salaryPreview')
        .removeClass('d-none alert-danger')
        .addClass('alert alert-info')
        .html(
          'Gross: ₹ ' + res.gross +
          '<br>Advance: ₹ ' + res.advances +
          '<br><strong>Suggested Pay: ₹ ' + res.net + '</strong>'
        );

      $('#paid_amount').val(res.net);
    });
  }

  $('#staff, #month').change(loadSalary);
});
</script>

{% endblock %}
